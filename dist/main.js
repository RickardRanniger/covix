(()=>{"use strict";var t,e,o,n,i,r,c,a,s;!function(t){t[t.UP=0]="UP",t[t.RIGHT=90]="RIGHT",t[t.DOWN=180]="DOWN",t[t.LEFT=270]="LEFT"}(a||(a={})),function(t){t.T="#800080",t.I="#00ffff",t.O="#ffff00",t.S="#00ff00",t.L="#ff7f00",t.J="#0000ff",t.Z="#ff0000"}(s||(s={}));var l,u=((t={color:s.T,code:"T"})[a.UP]=[[0,1,0],[1,1,1]],t[a.RIGHT]=[[1,0],[1,1],[1,0]],t[a.DOWN]=[[1,1,1],[0,1,0]],t[a.LEFT]=[[0,1],[1,1],[0,1]],t),f=((e={color:s.I,code:"I"})[a.UP]=[[0,1,0],[0,1,0],[0,1,0],[0,1,0]],e[a.RIGHT]=[[0,0,0,0],[1,1,1,1]],e[a.DOWN]=[[0,1,0],[0,1,0],[0,1,0],[0,1,0]],e[a.LEFT]=[[0,0,0,0],[1,1,1,1]],e),h=((o={color:s.O,code:"O"})[a.UP]=[[1,1],[1,1]],o[a.RIGHT]=[[1,1],[1,1]],o[a.DOWN]=[[1,1],[1,1]],o[a.LEFT]=[[1,1],[1,1]],o),p=((n={color:s.S,code:"S"})[a.UP]=[[0,1,1],[1,1,0]],n[a.RIGHT]=[[1,0],[1,1],[0,1]],n[a.DOWN]=[[0,1,1],[1,1,0]],n[a.LEFT]=[[1,0],[1,1],[0,1]],n),v=((i={color:s.Z,code:"Z"})[a.UP]=[[1,1,0],[0,1,1]],i[a.RIGHT]=[[0,1],[1,1],[1,0]],i[a.DOWN]=[[1,1,0],[0,1,1]],i[a.LEFT]=[[0,1],[1,1],[1,0]],i),d=((r={color:s.J,code:"J"})[a.UP]=[[1,0,0],[1,1,1]],r[a.RIGHT]=[[1,1],[1,0],[1,0]],r[a.DOWN]=[[1,1,1],[0,0,1]],r[a.LEFT]=[[0,1],[0,1],[1,1]],r),y=((c={color:s.L,code:"L"})[a.UP]=[[0,0,1],[1,1,1]],c[a.RIGHT]=[[1,0],[1,0],[1,1]],c[a.DOWN]=[[1,1,1],[1,0,0]],c[a.LEFT]=[[1,1],[0,1],[0,1]],c),k=[u,f,h,p,v,d,y];!function(t){t.ACTIVE="active",t.STATIC="static"}(l||(l={}));var w=function(t,e){this.type=t,this.color=e},b=function(){function t(t,e){var o=this;this.setActiveBlock=function(t){o.activeBlock=t,o.addBlock(l.ACTIVE)},this.moveDY=function(t){return!o.isCollision(o.activeBlock,o.activeBlock.position.x,o.activeBlock.position.y+t,o.activeBlock.rotation)&&(o.removeBlock(),o.activeBlock.position.y+=t,o.addBlock(l.ACTIVE),!0)},this.moveDX=function(t){o.isCollision(o.activeBlock,o.activeBlock.position.x+t,o.activeBlock.position.y,o.activeBlock.rotation)||(o.removeBlock(),o.activeBlock.position.x+=t,o.addBlock(l.ACTIVE))},this.getNextBlockRotation=function(t){switch(t){case a.UP:return a.RIGHT;case a.RIGHT:return a.DOWN;case a.DOWN:return a.LEFT;case a.LEFT:return a.UP}},this.lockDown=function(){o.processMatrix((function(t,e){var n;(null===(n=o.tiles[e][t])||void 0===n?void 0:n.type)===l.ACTIVE&&(o.tiles[e][t].type=l.STATIC)}),null)},this.rotate=function(){o.isCollision(o.activeBlock,o.activeBlock.position.x,o.activeBlock.position.y,o.getNextBlockRotation(o.activeBlock.rotation))||(o.removeBlock(),o.activeBlock.rotation=o.getNextBlockRotation(o.activeBlock.rotation),o.addBlock(l.ACTIVE))},this.processMatrix=function(t,e){for(var n=0;n<o.height;n++){e&&e(n);for(var i=0;i<o.width;i++)t&&t(i,n)}},this.addBlock=function(t){for(var e=o.activeBlock,n=0;n<e.blockType[e.rotation].length;n++)for(var i=0;i<e.blockType[e.rotation][n].length;i++)1===e.blockType[e.rotation][n][i]&&o.setTile(new w(t,e.blockType.color),i+e.position.x,n+e.position.y)},this.handleRows=function(){var t=!1;return o.processMatrix(null,(function(e){o.tiles[e].every((function(t){return(null==t?void 0:t.type)===l.STATIC}))&&(o.tiles.splice(e,1),o.tiles.unshift(new Array(o.width).fill(null)),t=!0)})),t},this.removeBlock=function(){for(var t=o.activeBlock,e=0;e<t.blockType[t.rotation].length;e++)for(var n=0;n<t.blockType[t.rotation][e].length;n++)1===t.blockType[t.rotation][e][n]&&o.setTile(null,t.position.x+n,t.position.y+e)},this.setTile=function(t,e,n){o.tiles[n][e]=t},this.width=t,this.height=e,this.tiles=[],this.clear()}return t.prototype.clear=function(){var t=this;this.processMatrix((function(e,o){return t.tiles[o][e]=null}),(function(e){return t.tiles[e]=[]}))},t.prototype.isCollision=function(t,e,o,n){for(var i=0;i<t.blockType[n].length;i++)for(var r=0;r<t.blockType[n][i].length;r++)if(1===t.blockType[n][i][r]&&(o+i>=this.height||e+r>=this.width||e+r<0||this.tiles[o+i][e+r]instanceof w&&this.tiles[o+i][e+r].type===l.STATIC))return!0;return!1},t.prototype.getTile=function(t,e){return this.tiles[e][t]},t.prototype.getTiles=function(){return this.tiles},t}(),T=function(t){var e=this;this.drawCurrent=function(){e.matrix.processMatrix((function(t,o){var n=e.matrix.getTile(t,o);null!==n&&(e.context.fillStyle=n.color,e.context.strokeStyle="#333333",e.context.strokeRect(32*t,32*o,32,32),e.context.fillRect(32*t,32*o,32,32))}),null)},this.clear=function(){e.context.clearRect(0,0,32*e.matrix.width,32*e.matrix.height)},this.matrix=t,this.canvas=document.createElement("canvas"),this.canvas.width=32*t.width,this.canvas.height=32*t.height,this.canvas.style.backgroundColor="black",this.context=this.canvas.getContext("2d"),document.body.appendChild(this.canvas)},x=function(t,e,o,n){return new(o||(o=Promise))((function(i,r){function c(t){try{s(n.next(t))}catch(t){r(t)}}function a(t){try{s(n.throw(t))}catch(t){r(t)}}function s(t){var e;t.done?i(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(c,a)}s((n=n.apply(t,e||[])).next())}))},m=function(t,e){var o,n,i,r,c={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,n&&(i=2&r[0]?n.return:r[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,r[1])).done)return i;switch(n=0,i&&(r=[2&r[0],i.value]),r[0]){case 0:case 1:i=r;break;case 4:return c.label++,{value:r[1],done:!1};case 5:c.label++,n=r[1],r=[0];continue;case 7:r=c.ops.pop(),c.trys.pop();continue;default:if(!((i=(i=c.trys).length>0&&i[i.length-1])||6!==r[0]&&2!==r[0])){c=0;continue}if(3===r[0]&&(!i||r[1]>i[0]&&r[1]<i[3])){c.label=r[1];break}if(6===r[0]&&c.label<i[1]){c.label=i[1],i=r;break}if(i&&c.label<i[2]){c.label=i[2],c.ops.push(r);break}i[2]&&c.ops.pop(),c.trys.pop();continue}r=e.call(t,c)}catch(t){r=[6,t],n=0}finally{o=i=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}};const B=function(){var t=this;this.audioContext=new AudioContext,this.buffers={},this.sounds={music:"assets/music.mp3",rotate:"assets/blip.wav",clearRows:"assets/clear.wav",drop:"assets/drop.wav",gameOver:"assets/gameOver.wav"},this.load=function(e){return x(t,void 0,void 0,(function(){var t;return m(this,(function(o){switch(o.label){case 0:return[4,fetch(e)];case 1:return[4,o.sent().arrayBuffer()];case 2:return t=o.sent(),[4,this.audioContext.decodeAudioData(t)];case 3:return[2,o.sent()]}}))}))},this.init=function(){return x(t,void 0,void 0,(function(){var t,e,o,n,i,r;return m(this,(function(c){switch(c.label){case 0:for(e in t=[],this.sounds)t.push(e);o=0,c.label=1;case 1:return o<t.length?(n=t[o],i=this.buffers,r=n,[4,this.load(this.sounds[n])]):[3,4];case 2:i[r]=c.sent(),c.label=3;case 3:return o++,[3,1];case 4:return[2]}}))}))},this.play=function(e,o){void 0===o&&(o=!1);var n=t.audioContext.createBufferSource();n.buffer=t.buffers[e],n.connect(t.audioContext.destination),n.loop=o,n.start()}};var g=function(t,e,o,n){return new(o||(o=Promise))((function(i,r){function c(t){try{s(n.next(t))}catch(t){r(t)}}function a(t){try{s(n.throw(t))}catch(t){r(t)}}function s(t){var e;t.done?i(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(c,a)}s((n=n.apply(t,e||[])).next())}))},C=function(t,e){var o,n,i,r,c={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,n&&(i=2&r[0]?n.return:r[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,r[1])).done)return i;switch(n=0,i&&(r=[2&r[0],i.value]),r[0]){case 0:case 1:i=r;break;case 4:return c.label++,{value:r[1],done:!1};case 5:c.label++,n=r[1],r=[0];continue;case 7:r=c.ops.pop(),c.trys.pop();continue;default:if(!((i=(i=c.trys).length>0&&i[i.length-1])||6!==r[0]&&2!==r[0])){c=0;continue}if(3===r[0]&&(!i||r[1]>i[0]&&r[1]<i[3])){c.label=r[1];break}if(6===r[0]&&c.label<i[1]){c.label=i[1],i=r;break}if(i&&c.label<i[2]){c.label=i[2],c.ops.push(r);break}i[2]&&c.ops.pop(),c.trys.pop();continue}r=e.call(t,c)}catch(t){r=[6,t],n=0}finally{o=i=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}};!function(){g(this,void 0,void 0,(function(){var t,e,o,n,i,r,c,s,l,u,h,p,v,d,y=this;return C(this,(function(w){return(t=new B).init(),e=new b(10,20),o={blockType:f,position:{x:0,y:0},rotation:a.UP},n=function(){return g(y,void 0,void 0,(function(){return C(this,(function(e){return t.play("music",!0),d(window.performance.now()),[2]}))}))},(i=document.createElement("button")).textContent="Start game",i.style.display="block ",i.onclick=n,document.body.appendChild(i),e.setActiveBlock(o),r=new T(e),c=0,s=1,l=!1,u=!1,h=!1,window.addEventListener("keydown",(function(o){switch(o.preventDefault(),o.key){case"ArrowRight":l=!0;break;case"ArrowLeft":u=!0;break;case"ArrowUp":t.play("rotate"),e.rotate();break;case"ArrowDown":s=.0333333;break;case" ":h=!0}})),window.addEventListener("keyup",(function(t){switch(t.preventDefault(),t.key){case"ArrowDown":s=1;break;case"ArrowRight":l=!1;break;case"ArrowLeft":u=!1}})),p=0,v=0,d=function(n){void 0===n&&(n=0),h||window.requestAnimationFrame(d);var i=(n-c)/1e3;c=n,p>=s?(e.moveDY(1)||(t.play("drop"),e.lockDown(),e.handleRows()&&t.play("clearRows"),o.position.x=0,o.position.y=0,o.rotation=a.UP,o.blockType=k[Math.floor(Math.random()*k.length)],e.isCollision(o,0,0,a.UP)?h=!0:e.setActiveBlock(o)),p=0):p+=i,(u||l)&&v>=.1?(e.moveDX(u?-1:1),v=0):v+=i,r.clear(),r.drawCurrent()},r.drawCurrent(),[2]}))}))}()})();